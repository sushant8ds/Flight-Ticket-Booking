---
# System configuration tasks

- name: Set system timezone
  timezone:
    name: "{{ timezone }}"
  become: yes
  notify: restart systemd-timesyncd
  tags:
    - system
    - timezone

- name: Generate locale (Debian/Ubuntu)
  locale_gen:
    name: "{{ locale }}"
    state: present
  become: yes
  when: ansible_os_family == "Debian"
  tags:
    - system
    - locale

- name: Set system locale (Debian/Ubuntu)
  lineinfile:
    path: /etc/default/locale
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    create: yes
    backup: yes
  become: yes
  loop:
    - { key: 'LANG', value: '{{ locale }}' }
    - { key: 'LC_ALL', value: '{{ locale }}' }
    - { key: 'LC_CTYPE', value: '{{ locale }}' }
  when: ansible_os_family == "Debian"
  tags:
    - system
    - locale

- name: Configure system environment variables
  lineinfile:
    path: /etc/environment
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    create: yes
    backup: yes
  become: yes
  loop: "{{ system_environment | dict2items }}"
  when: system_environment is defined
  tags:
    - system
    - environment

- name: Configure system limits
  pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
    backup: yes
  become: yes
  loop: "{{ system_limits }}"
  when: system_limits is defined
  tags:
    - system
    - limits

- name: Configure kernel parameters
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  become: yes
  loop: "{{ kernel_parameters | dict2items }}"
  when: kernel_parameters is defined
  vars:
    kernel_parameters:
      vm.swappiness: 10
      vm.dirty_ratio: 15
      vm.dirty_background_ratio: 5
      net.core.somaxconn: 1024
      net.core.netdev_max_backlog: 5000
      net.ipv4.tcp_max_syn_backlog: 1024
      fs.file-max: 65536
  tags:
    - system
    - kernel

- name: Configure systemd journal settings
  lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^#?{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    backup: yes
  become: yes
  loop:
    - { key: 'SystemMaxUse', value: '100M' }
    - { key: 'SystemMaxFileSize', value: '10M' }
    - { key: 'MaxRetentionSec', value: '1month' }
    - { key: 'Compress', value: 'yes' }
  notify: restart systemd-journald
  tags:
    - system
    - logging

- name: Configure logrotate for system logs
  template:
    src: logrotate.conf.j2
    dest: /etc/logrotate.d/{{ app_name }}
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - system
    - logging

- name: Enable and start essential services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  loop: "{{ services_to_enable }}"
  ignore_errors: yes
  tags:
    - system
    - services

- name: Disable unnecessary services
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  become: yes
  loop: "{{ services_to_disable }}"
  ignore_errors: yes
  tags:
    - system
    - services

- name: Configure automatic package updates (if enabled)
  apt:
    name: unattended-upgrades
    state: present
  become: yes
  when: 
    - ansible_os_family == "Debian"
    - automatic_updates | default(false)
  tags:
    - system
    - updates

- name: Configure unattended-upgrades
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
    backup: yes
  become: yes
  when: 
    - ansible_os_family == "Debian"
    - automatic_updates | default(false)
  tags:
    - system
    - updates

- name: Verify system configuration
  command: "{{ item }}"
  register: system_check
  changed_when: false
  failed_when: false
  loop:
    - "timedatectl status"
    - "locale"
    - "ulimit -n"
  tags:
    - system
    - verification

- name: Display system configuration status
  debug:
    msg: "System configuration completed. Timezone: {{ timezone }}, Locale: {{ locale }}"
  tags:
    - system
    - verification